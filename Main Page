import json
import random


class Session:
    storage = "Profiles"

    foods = [
        "pizza",
        "chicken",
        "rice",
        "noodles",
        "tandoori chicken",
        "spaghetti",
        "sushi",
        "steak",
        "hamburger",
        "tacos",
        "barbecue ribs",
        "dumplings",
        "soup",
        "waffles",
        "pulled pork",
        "grilled salmon",
        "calamari",
    ]

    def create_account(self):
        username = input("Enter a username: ")
        password = input("Enter a password: ")
        account = {username: password, "global_dict": {}}
        with open(f"{self.storage}/{username}.json", "w") as f:
            json.dump(account, f, indent=4, separators=(',', ': '))
        print("Account created successfully!")
        return username

    @staticmethod
    def login():
        username = input("Enter your username: ")
        password = input("Enter your password: ")
        try:
            with open(f"Profiles/{username}.json", "r") as f:
                account = json.load(f)
                if account[username] == password:
                    print("Login successful!")
                else:
                    print("Invalid username/password combination")
        except FileNotFoundError:
            print("Account does not exist.")
        return username

    @staticmethod
    def ask_user_preference(first_option, second_option):
        print(f"Do you prefer: {first_option} or {second_option}?")
        choice = int(
            input("Enter 1 for the first option or 2 for the second: "))
        return choice

    def gather_food_preferences(self, foods):
        choice_data = []
        first_food = random.choice(self.foods)

        for _ in range(min(3, len(self.foods) - 1)):
            second_food = random.choice([
                food for food in self.foods if food != first_food
            ])
            choice = self.ask_user_preference(first_food, second_food)

            if choice == 2:
                first_food, second_food = second_food, first_food

            choice_data.append((first_food, second_food))
            self.foods.remove(second_food)

        self.foods.remove(first_food)
        return choice_data

    @staticmethod
    def store_local(choice_data):
        local_dict = {}
        for choice_tuple in choice_data:
            food1, food2 = choice_tuple

            if food1 not in local_dict:
                local_dict[food1] = local_dict.get(food2, 0) + 1
            else:
                local_dict[food1] += 1

            if food2 not in local_dict:
                Session.foods.append(food2)

        return local_dict

    @staticmethod
    def update_global(local_dict, global_dict):
        for food, count in local_dict.items():
            if food in global_dict:
                global_dict[food] += count
            else:
                global_dict[food] = count

        return dict(sorted(global_dict.items(), key=lambda item: item[1], reverse=True))

    @staticmethod
    def confirmation():
        print("Do you want to re-try or continue?")
        answer = int(input("Enter 1 to Re-Try or 2 to Continue: "))
        return answer == 2


if __name__ == '__main__':
    ActiveSession = Session()

    while True:
        choice = input(
            "Enter '1' to create a new account or '2' to login to an existing one: ")
        if choice == '1':
            username = ActiveSession.create_account()
            break
        elif choice == '2':
            username = ActiveSession.login()
            break
        else:
            print("Invalid choice. Please enter '1' or '2'.")

    try:
        with open(f"Profiles/{username}.json", "r") as f:
            global_dict = json.load(f)["global_dict"]
    except FileNotFoundError:
        raise SystemExit

    while True:
        choice_data = ActiveSession.gather_food_preferences(Session.foods)
        local_dict = ActiveSession.store_local(choice_data)
        global_dict = ActiveSession.update_global(local_dict, global_dict)
        user_confirmation = ActiveSession.confirmation()

        if user_confirmation:
            break

    with open(f"Profiles/{username}.json", "r+") as f:
        account = json.load(f)
        account["global_dict"] = global_dict
        f.seek(0)
        json.dump(account, f, indent=4, separators=(',', ': '))
        f.truncate()

    print(global_dict)
